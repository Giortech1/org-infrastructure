# .github/workflows/app-deploy.yml - UPDATED VERSION with academyaxis237
name: Deploy Application

on:
  push:
    branches:
      - develop
      - uat
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy (dev, uat, prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - uat
          - prod

jobs:
  determine-context:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      application: ${{ steps.set-app.outputs.application }}
      project_id: ${{ steps.load-config.outputs.project_id }}
      project_number: ${{ steps.load-config.outputs.project_number }}
      service_name: ${{ steps.load-config.outputs.service_name }}
      region: ${{ steps.load-config.outputs.region }}
      min_instances: ${{ steps.load-config.outputs.min_instances }}
      max_instances: ${{ steps.load-config.outputs.max_instances }}
      memory: ${{ steps.load-config.outputs.memory }}
      cpu: ${{ steps.load-config.outputs.cpu }}
      repository_type: ${{ steps.set-app.outputs.repository_type }}
      should_deploy: ${{ steps.set-app.outputs.should_deploy }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set environment based on branch or input
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/uat" ]]; then
            echo "environment=uat" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi
      
      - name: Set application and repository type
        id: set-app
        run: |
          # Extract repository name
          REPO_NAME="${{ github.repository }}"
          REPO_PART=$(echo $REPO_NAME | cut -d'/' -f2)
          
          echo "Repository: $REPO_NAME"
          echo "Repository part: $REPO_PART"
          
          # Check repository type and set application
          if [[ "$REPO_PART" == "org-infrastructure" ]]; then
            echo "repository_type=infrastructure" >> $GITHUB_OUTPUT
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "application=giortech" >> $GITHUB_OUTPUT  # Default for infrastructure
            echo "ğŸ—ï¸ Infrastructure repository detected - skipping application deployment"
          elif [[ "$REPO_PART" == *"giortech"* ]]; then
            echo "repository_type=application" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "application=giortech" >> $GITHUB_OUTPUT
            echo "ğŸŒ Giortech application repository detected"
          elif [[ "$REPO_PART" == *"waspwallet"* ]]; then
            echo "repository_type=application" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "application=waspwallet" >> $GITHUB_OUTPUT
            echo "ğŸ“± WaspWallet application repository detected"
          elif [[ "$REPO_PART" == *"academyaxis"* && "$REPO_PART" == *"237"* ]]; then
            # âœ… NEW: Handle academyaxis-237 repositories
            echo "repository_type=application" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "application=academyaxis237" >> $GITHUB_OUTPUT
            echo "ğŸ“ AcademyAxis-237 application repository detected"
          elif [[ "$REPO_PART" == *"academyaxis"* ]]; then
            echo "repository_type=application" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "application=academyaxis" >> $GITHUB_OUTPUT
            echo "ğŸ“ AcademyAxis application repository detected"
          else
            echo "repository_type=unknown" >> $GITHUB_OUTPUT
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "application=giortech" >> $GITHUB_OUTPUT
            echo "â“ Unknown repository type - skipping deployment"
          fi
      
      - name: Load configuration
        id: load-config
        run: |
          APP="${{ steps.set-app.outputs.application }}"
          ENV="${{ steps.set-env.outputs.environment }}"
          REPO_TYPE="${{ steps.set-app.outputs.repository_type }}"
          
          echo "Loading config for $APP in $ENV environment (repo type: $REPO_TYPE)"
          
          # Only load config if we're deploying
          if [[ "${{ steps.set-app.outputs.should_deploy }}" == "true" ]]; then
            # Configuration mapping based on your project knowledge
            case "$APP-$ENV" in
              "giortech-dev")
                echo "project_id=giortech-dev-project" >> $GITHUB_OUTPUT
                echo "project_number=653675374627" >> $GITHUB_OUTPUT
                echo "service_name=giortech-dev" >> $GITHUB_OUTPUT
                ;;
              "giortech-uat")
                echo "project_id=giortech-uat-project" >> $GITHUB_OUTPUT
                echo "project_number=28962750525" >> $GITHUB_OUTPUT
                echo "service_name=giortech-uat" >> $GITHUB_OUTPUT
                ;;
              "giortech-prod")
                echo "project_id=giortech-prod-project" >> $GITHUB_OUTPUT
                echo "project_number=371831144642" >> $GITHUB_OUTPUT
                echo "service_name=giortech-prod" >> $GITHUB_OUTPUT
                ;;
              "waspwallet-dev")
                echo "project_id=waspwallet-dev-project" >> $GITHUB_OUTPUT
                echo "project_number=260301647000" >> $GITHUB_OUTPUT
                echo "service_name=waspwallet-dev" >> $GITHUB_OUTPUT
                ;;
              "waspwallet-uat")
                echo "project_id=waspwallet-uat-project" >> $GITHUB_OUTPUT
                echo "project_number=875164789138" >> $GITHUB_OUTPUT
                echo "service_name=waspwallet-uat" >> $GITHUB_OUTPUT
                ;;
              "waspwallet-prod")
                echo "project_id=waspwallet-prod-project" >> $GITHUB_OUTPUT
                echo "project_number=142392555937" >> $GITHUB_OUTPUT
                echo "service_name=waspwallet-prod" >> $GITHUB_OUTPUT
                ;;
              "academyaxis-dev")
                echo "project_id=academyaxis-dev-project" >> $GITHUB_OUTPUT
                echo "project_number=1052274887859" >> $GITHUB_OUTPUT
                echo "service_name=academyaxis-dev" >> $GITHUB_OUTPUT
                ;;
              "academyaxis-uat")
                echo "project_id=academyaxis-uat-project" >> $GITHUB_OUTPUT
                echo "project_number=415071431590" >> $GITHUB_OUTPUT
                echo "service_name=academyaxis-uat" >> $GITHUB_OUTPUT
                ;;
              "academyaxis-prod")
                echo "project_id=academyaxis-prod-project" >> $GITHUB_OUTPUT
                echo "project_number=552816176477" >> $GITHUB_OUTPUT
                echo "service_name=academyaxis-prod" >> $GITHUB_OUTPUT
                ;;
              # âœ… NEW: Added academyaxis237 configurations
              "academyaxis237-dev")
                echo "project_id=academyaxis-237-dev-project" >> $GITHUB_OUTPUT
                echo "project_number=425169602074" >> $GITHUB_OUTPUT
                echo "service_name=academyaxis237-dev" >> $GITHUB_OUTPUT
                ;;
              "academyaxis237-uat")
                echo "project_id=academyaxis-237-uat-project" >> $GITHUB_OUTPUT
                echo "project_number=523018028271" >> $GITHUB_OUTPUT
                echo "service_name=academyaxis237-uat" >> $GITHUB_OUTPUT
                ;;
              "academyaxis237-prod")
                echo "project_id=academyaxis-237-prod-project" >> $GITHUB_OUTPUT
                echo "project_number=684266177356" >> $GITHUB_OUTPUT
                echo "service_name=academyaxis237-prod" >> $GITHUB_OUTPUT
                ;;
              *)
                echo "::error::Unknown application-environment combination: $APP-$ENV"
                exit 1
                ;;
            esac
            
            # Common configuration
            echo "region=us-central1" >> $GITHUB_OUTPUT
            echo "memory=512Mi" >> $GITHUB_OUTPUT
            echo "cpu=1" >> $GITHUB_OUTPUT
            echo "min_instances=0" >> $GITHUB_OUTPUT
            echo "max_instances=10" >> $GITHUB_OUTPUT
          else
            echo "Skipping configuration load for infrastructure repository"
          fi

  # Job for infrastructure repository - no deployment
  infrastructure-info:
    needs: determine-context
    if: needs.determine-context.outputs.repository_type == 'infrastructure'
    runs-on: ubuntu-latest
    
    steps:
      - name: Infrastructure repository information
        run: |
          echo "ğŸ—ï¸ org-infrastructure Repository"
          echo "================================="
          echo ""
          echo "This is the infrastructure management repository."
          echo "It contains Terraform configurations, setup scripts, and deployment workflows."
          echo ""
          echo "For application deployments, use the respective application repositories:"
          echo "  ğŸ“± giortech-app       â†’ Giortech website"
          echo "  ğŸ“± waspwallet-app     â†’ WaspWallet mobile app"
          echo "  ğŸ“± academyaxis-app    â†’ AcademyAxis platform"
          echo "  ğŸ“± academyaxis-237-app â†’ AcademyAxis-237 platform"
          echo ""
          echo "Environment: ${{ needs.determine-context.outputs.environment }}"
          echo "Application: ${{ needs.determine-context.outputs.application }}"
          echo ""
          echo "â„¹ï¸ No Docker build or deployment will be performed from this repository."

  # Job for application repositories - full deployment
  get-workload-identity:
    needs: determine-context
    if: needs.determine-context.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    outputs:
      wi_provider: ${{ steps.set-wi.outputs.wi_provider }}
      sa_email: ${{ steps.set-wi.outputs.sa_email }}
    
    steps:
      - name: Set Workload Identity values
        id: set-wi
        run: |
          PROJECT_NUMBER="${{ needs.determine-context.outputs.project_number }}"
          PROJECT_ID="${{ needs.determine-context.outputs.project_id }}"
          
          echo "wi_provider=projects/${PROJECT_NUMBER}/locations/global/workloadIdentityPools/github-pool/providers/github-provider" >> $GITHUB_OUTPUT
          echo "sa_email=github-actions-sa@${PROJECT_ID}.iam.gserviceaccount.com" >> $GITHUB_OUTPUT

  deploy:
    needs: [determine-context, get-workload-identity]
    if: needs.determine-context.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    permissions:
      contents: 'read'
      id-token: 'write'
    
    environment: ${{ needs.determine-context.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify Dockerfile exists
        run: |
          if [ ! -f "Dockerfile" ]; then
            echo "âŒ Dockerfile not found in application repository"
            echo "ğŸ“‹ Available files:"
            ls -la
            echo ""
            echo "ğŸ’¡ Make sure you're running this workflow from an application repository that contains:"
            echo "   - Dockerfile"
            echo "   - Application source code"
            exit 1
          fi
          echo "âœ… Dockerfile found - proceeding with deployment"
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ needs.get-workload-identity.outputs.wi_provider }}
          service_account: ${{ needs.get-workload-identity.outputs.sa_email }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ needs.determine-context.outputs.project_id }}
      
      - name: Verify GCP connection
        run: |
          echo "ğŸ” Testing GCP connection:"
          gcloud auth list
          gcloud config list project
          
          echo "ğŸ“‹ Current project info:"
          gcloud projects describe ${{ needs.determine-context.outputs.project_id }}
      
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev
      
      - name: Create Artifact Registry repository if needed
        run: |
          PROJECT_ID="${{ needs.determine-context.outputs.project_id }}"
          APP="${{ needs.determine-context.outputs.application }}"
          ENV="${{ needs.determine-context.outputs.environment }}"
          
          # Determine repository name based on application
          if [[ "$APP" == "academyaxis237" ]]; then
            REPO_NAME="academyaxis-237-$ENV"
          else
            REPO_NAME="$APP-$ENV"
          fi
          
          echo "ğŸ—ï¸ Checking Artifact Registry repository: $REPO_NAME"
          
          if ! gcloud artifacts repositories describe $REPO_NAME \
            --location=us-central1 \
            --project=$PROJECT_ID &>/dev/null; then
            
            echo "ğŸ“¦ Creating Artifact Registry repository: $REPO_NAME"
            gcloud artifacts repositories create $REPO_NAME \
              --repository-format=docker \
              --location=us-central1 \
              --description="Docker repository for $APP $ENV environment" \
              --project=$PROJECT_ID
          else
            echo "âœ… Artifact Registry repository already exists: $REPO_NAME"
          fi
      
      - name: Build and Push Docker Image
        run: |
          PROJECT_ID="${{ needs.determine-context.outputs.project_id }}"
          SERVICE_NAME="${{ needs.determine-context.outputs.service_name }}"
          APP="${{ needs.determine-context.outputs.application }}"
          ENV="${{ needs.determine-context.outputs.environment }}"
          
          # Determine repository name and image tag based on application
          if [[ "$APP" == "academyaxis237" ]]; then
            REPO_NAME="academyaxis-237-$ENV"
            IMAGE_TAG="us-central1-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/app:${{ github.sha }}"
          else
            REPO_NAME="$APP-$ENV"
            IMAGE_TAG="us-central1-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/app:${{ github.sha }}"
          fi
          
          echo "ğŸ—ï¸ Building Docker image: $IMAGE_TAG"
          docker build -t "$IMAGE_TAG" .
          
          echo "ğŸ“¤ Pushing Docker image..."
          docker push "$IMAGE_TAG"
          
          # Store image tag for later use
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
      
      - name: Deploy to Cloud Run with Firebase Support
        run: |
          PROJECT_ID="${{ needs.determine-context.outputs.project_id }}"
          SERVICE_NAME="${{ needs.determine-context.outputs.service_name }}"
          APP="${{ needs.determine-context.outputs.application }}"
          ENV="${{ needs.determine-context.outputs.environment }}"
          IMAGE_TAG="$IMAGE_TAG"
          
          echo "ğŸš€ Deploying to Cloud Run..."
          gcloud run deploy $SERVICE_NAME \
            --image="$IMAGE_TAG" \
            --project=$PROJECT_ID \
            --region=${{ needs.determine-context.outputs.region }} \
            --platform=managed \
            --allow-unauthenticated \
            --set-env-vars="GOOGLE_CLOUD_PROJECT=$PROJECT_ID,NODE_ENV=$ENV,ENVIRONMENT=$ENV,APPLICATION=$APP" \
            --memory=${{ needs.determine-context.outputs.memory }} \
            --cpu=${{ needs.determine-context.outputs.cpu }} \
            --min-instances=${{ needs.determine-context.outputs.min_instances }} \
            --max-instances=${{ needs.determine-context.outputs.max_instances }} \
            --timeout=300s \
            --execution-environment=gen2
      
      - name: Test Firebase Connection Post-Deploy
        run: |
          echo "ğŸ§ª Testing deployed service..."
          
          # Get service URL
          SERVICE_URL=$(gcloud run services describe ${{ needs.determine-context.outputs.service_name }} \
            --project=${{ needs.determine-context.outputs.project_id }} \
            --region=${{ needs.determine-context.outputs.region }} \
            --format="get(status.url)")
          
          echo "ğŸŒ Service URL: $SERVICE_URL"
          
          # Wait for service to be ready
          echo "â³ Waiting for service to be ready..."
          sleep 30
          
          # Test health endpoint (if available)
          if curl -f "$SERVICE_URL/health" 2>/dev/null; then
            echo "âœ… Health check passed"
          else
            echo "âš ï¸ Health endpoint not available (this is normal if not implemented)"
          fi
          
          # Test basic connectivity
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$SERVICE_URL" || echo "TIMEOUT")
          echo "ğŸ“Š Service response status: $HTTP_STATUS"
      
      - name: Deploy Summary
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“‹ Summary:"
          echo "  Application: ${{ needs.determine-context.outputs.application }}"
          echo "  Environment: ${{ needs.determine-context.outputs.environment }}"
          echo "  Project: ${{ needs.determine-context.outputs.project_id }}"
          echo "  Service: ${{ needs.determine-context.outputs.service_name }}"
          echo "  Region: ${{ needs.determine-context.outputs.region }}"
          echo "  Image: $IMAGE_TAG"
          echo "  Firebase Enabled: âœ…"